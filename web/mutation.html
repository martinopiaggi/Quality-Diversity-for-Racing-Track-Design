<!DOCTYPE html>
<html lang="en">
<head>
  <title>Mutation Visualization</title>
  <script src="/src/lib/p5.js"></script>
  <script src="/src/lib/rhill-voronoi-core.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <div class="visualization">
      <div class="canvas-wrapper">
        <div id="track-container"></div>
      </div>
    </div>
    <div class="controls">
      <form id="trackForm">
        <label for="seedInput">Enter Seed:</label>
        <input type="text" id="seedInput" name="seedInput">
        <label for="cellCountInput">Enter Number of Cell Tracks:</label>
        <input type="text" id="cellCountInput" name="cellCountInput">
        <label for="intensityInput">Intensity Mutation (default 10):</label>
        <input type="text" id="intensityInput" name="intensityInput">
        <label for="modeSelect">Select Track Generator Mode:</label>
        <select id="modeSelect" name="modeSelect">
          <option value="voronoi">Voronoi</option>
          <option value="convexHull">Convex Hull</option>
        </select>
        <button type="submit">Generate Track</button>
      </form>
      <div class="checkbox-group">
        <label><input type="checkbox" id="showVoronoi" checked> Show Voronoi</label>
        <label><input type="checkbox" id="showPoints" checked> Show Points</label>
        <label><input type="checkbox" id="showSpline" checked> Show Spline</label>
      </div>
    </div>
  </div>

  <script type="module">
    import { generateTrack } from '../src/trackGen/trackGenerator.js';
    import { mutation, mutationConvexHull } from "../src/genetic/mutation.js";
    import { BBOX, COLORS } from "../src/utils/constants.js";

    let trackResult;
    let splinePoints = [];

    function setupEventListeners() {
      document.getElementById('trackForm').addEventListener('submit', handleFormSubmit);
      document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', redraw);
      });
    }

    function handleFormSubmit(event) {
      event.preventDefault();
      const seed = parseFloat(document.getElementById('seedInput').value);
      const trackSize = parseInt(document.getElementById('cellCountInput').value);
      const mode = document.getElementById('modeSelect').value;
      const intensity = parseFloat(document.getElementById('intensityInput').value);
      genTrack(seed, trackSize, intensity, mode);
    }

    async function genTrack(seed, trackSize, intensityMutation, mode) {
      if (isNaN(seed)) seed = 42;
      if (mode === "voronoi") {
        if (isNaN(trackSize)) trackSize = 5;
        if(trackSize>50){
        alert('trackSize too high!');
        trackSize = 5;
        }
      } else {
        if (isNaN(trackSize)) trackSize = 50;
      }
      
      trackResult = await generateTrack(mode, BBOX, seed, trackSize);

      if (mode === "voronoi") {
        if (isNaN(intensityMutation)) intensityMutation = 10;
        const mutated = mutation(trackResult.generator, intensityMutation);
        trackResult = await generateTrack(mode, BBOX, seed, trackSize, false, mutated.ds, mutated.sel);
      } else {
        if (isNaN(intensityMutation)) intensityMutation = 10;
        const mutated = mutationConvexHull(trackResult.generator, intensityMutation);
        trackResult = await generateTrack(mode, BBOX, seed, trackSize, false, mutated.ds, mutated.hull);
      }

      splinePoints = await trackResult.track;
      redraw();
    }

    function drawVoronoi() {
      strokeWeight(1);
      const diagram = trackResult.generator.diagram;
      if (!diagram) return;
      stroke(COLORS.VORONOI);
      diagram.edges.forEach(edge => {
        line(edge.va.x, edge.va.y, edge.vb.x, edge.vb.y);
      });
    }

    function drawPoints() {
      strokeWeight(1);
      const dataSet = trackResult.generator.dataSet;
      if (!dataSet) return;
      fill(COLORS.POINTS);
      noStroke();
      dataSet.forEach(pt => ellipse(pt.x, pt.y, 5, 5));
    }

    function drawAnimatedSpline() {
      beginShape();
      for (let i = 0; i < splinePoints.length; i++) {
        let t = (i / splinePoints.length + frameCount * 0.02) % 1;
        t = (t + 1) % 1;

        let colorIndex = floor(t * COLORS.SPLINE.length);
        let nextColorIndex = (colorIndex + 1) % COLORS.SPLINE.length;
        let colorT = (t * COLORS.SPLINE.length) % 1;

        let c = lerpColor(color(...COLORS.SPLINE[colorIndex]), color(...COLORS.SPLINE[nextColorIndex]), colorT);

        stroke(c);
        strokeWeight(4);
        point(splinePoints[i].x, splinePoints[i].y);
      }
      endShape(CLOSE);
    }

    window.setup = function setup() {
      const trackContainer = document.getElementById('track-container');
      const canvas = createCanvas(BBOX.xr, BBOX.yb);
      canvas.parent(trackContainer);
      frameRate(60);
      loop();
    };

    window.draw = function draw() {
      background(COLORS.BACKGROUND);

      if (trackResult && trackResult.track) {
        if (document.getElementById('showVoronoi').checked) {
          drawVoronoi();
        }
        if (document.getElementById('showPoints').checked) {
          drawPoints();
        }
        if (document.getElementById('showSpline').checked) {
          drawAnimatedSpline();
        }
      }
    };

    // Initialization
    document.addEventListener('DOMContentLoaded', setupEventListeners);
  </script>
</body>
</html>
