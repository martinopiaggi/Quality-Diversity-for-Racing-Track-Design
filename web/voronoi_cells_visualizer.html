<!DOCTYPE html>
<html lang="en">
<head>
  <title>Voronoi Track Visualization</title>
  <script src="/src/lib/p5.js"></script>
  <script src="/src/lib/rhill-voronoi-core.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <main>
    <form id="trackForm">
      <label for="seedInput">Enter Seed:</label>
      <input type="text" id="seedInput" name="seedInput">
      <label for="cellCountInput">Enter Number of Cell Tracks:</label>
      <input type="text" id="cellCountInput" name="cellCountInput">
      <button type="submit">Generate Track</button>
    </form>
    <div>
      <label><input type="checkbox" id="showVoronoi" checked> Show Voronoi</label>
      <label><input type="checkbox" id="showPoints" checked> Show Points</label>
      <label><input type="checkbox" id="showEdges" checked> Show Edges</label>
      <label><input type="checkbox" id="showSpline" checked> Show Spline</label>
    </div>
  </main>

  <script type="module">
    import { generateTrack } from '../src/trackGen/trackGenerator.js';

// Constants and global variables
const BBOX = { xl: 0, xr: 600, yt: 0, yb: 600 };
const COLORS = {
  VORONOI: [88, 86, 214],    // Soft Blue
  POINTS: [255, 45, 85],     // Vibrant Coral
  EDGES: [76, 217, 100],     // Muted Green
  BACKGROUND: [18, 18, 18],  // Dark Grey (Material Design background)
  SPLINE: [
    [88, 86, 214],   // Soft Blue (inspired by Apple iOS)
    [255, 45, 85],   // Vibrant Coral (inspired by Apple iOS)
    [103, 58, 183],  // Deep Purple (from Material Design)
    [255, 196, 0]    // Warm Yellow (from Material Design)
  ]
};
let trackResult;
let splinePoints = [];

// DOM-related functions
function setupEventListeners() {
  document.getElementById('trackForm').addEventListener('submit', handleFormSubmit);
  document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
    checkbox.addEventListener('change', () => redraw());
  });
}

function handleFormSubmit(event) {
  event.preventDefault();
  const seed = parseFloat(document.getElementById('seedInput').value);
  const trackSize = parseInt(document.getElementById('cellCountInput').value);
  genTrack(seed, trackSize);
}

// Track generation function
async function genTrack(seed, trackSize) {
  if (isNaN(seed)) seed = Math.random();
  trackResult = await generateTrack("voronoi", BBOX, seed, trackSize);
  splinePoints = await trackResult.track;
  loop(); // Start the animation loop
}

// P5.js setup and draw functions
window.setup = function() {
  createCanvas(BBOX.xr, BBOX.yb);
  frameRate(30);
  loop();
}

window.draw = function() {
  background(COLORS.BACKGROUND);
  if (trackResult) {
    if (document.getElementById('showVoronoi').checked) drawVoronoi();
    if (document.getElementById('showPoints').checked) drawPoints();
    if (document.getElementById('showEdges').checked) drawOriginalEdges();
    if (document.getElementById('showSpline').checked) drawAnimatedSpline();
  }
}

// Drawing functions
function drawVoronoi() {
  stroke(COLORS.VORONOI);
  strokeWeight(1);
  const diagram = trackResult.generator.diagram;
  diagram.edges.forEach(edge => line(edge.va.x, edge.va.y, edge.vb.x, edge.vb.y));
}

function drawPoints() {
  const dataSet = trackResult.generator.dataSet;
  fill(COLORS.POINTS);
  noStroke();
  dataSet.forEach(pt => ellipse(pt.x, pt.y, 5, 5));
}

function drawOriginalEdges() {
  const trackEdges = trackResult.generator.trackEdges;
  stroke(COLORS.EDGES);
  strokeWeight(2);
  for (let i = 0; i < trackEdges.length; i++) {
    let nextIndex = (i + 1) % trackEdges.length;
    line(trackEdges[i].x, trackEdges[i].y, trackEdges[nextIndex].x, trackEdges[nextIndex].y);
  }
  strokeWeight(1);
}

function drawAnimatedSpline() {
  if (splinePoints.length === 0) return;

  beginShape();
  for (let i = 0; i < splinePoints.length; i++) {
    let t = (i / splinePoints.length + frameCount * 0.02) % 1;
    t = (t + 1) % 1; // Ensure t is always positive
    
    let colorIndex = floor(t * COLORS.SPLINE.length);
    let nextColorIndex = (colorIndex + 1) % COLORS.SPLINE.length;
    let colorT = (t * COLORS.SPLINE.length) % 1;
    
    let c = lerpColor(color(...COLORS.SPLINE[colorIndex]), color(...COLORS.SPLINE[nextColorIndex]), colorT);
    
    stroke(c);
    strokeWeight(3);
    point(splinePoints[i].x, splinePoints[i].y);
  }
  endShape(CLOSE);
}

// Initialization
document.addEventListener('DOMContentLoaded', () => {
  setupEventListeners();
});
  </script>
</body>
</html>
