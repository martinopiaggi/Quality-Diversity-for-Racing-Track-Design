<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Track Gallery Visualization</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; connect-src 'self'">
  <script src="/src/lib/p5.js"></script>
  <link rel="stylesheet" type="text/css" href="style.css">
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
      margin: 0;
      padding: 20px;
    }
    .gallery-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 80%;
      margin-top: 20px;
    }
    .track-container {
      margin-bottom: 20px;
      text-align: center;
    }
    .navigation {
      display: flex;
      justify-content: space-between;
      width: 100%;
      margin-top: 10px;
    }
    .stats {
      margin-top: 20px;
    }
    canvas {
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <div class="gallery-container">
    <form id="trackForm">
      <label for="seedInput">Enter Seed:</label>
      <input type="text" id="seedInput" name="seedInput">
      <label for="cellCountInput">Enter Number of Cell Tracks:</label>
      <input type="text" id="cellCountInput" name="cellCountInput">
      <label for="modeSelect">Select Track Generator Mode:</label>
      <select id="modeSelect" name="modeSelect">
        <option value="voronoi">Voronoi</option>
        <option value="convexHull">Convex Hull</option>
      </select>
      <button type="submit">Generate Track</button>
    </form>
    <div id="track-container" class="track-container"></div>
    <div class="navigation">
      <button id="prev-track">Previous</button>
      <button id="next-track">Next</button>
    </div>
    <div id="stats-container" class="stats"></div>
  </div>
  <script type="module">
    import { TrackGeneratorFactory } from '/src/trackGen/trackGeneratorFactory.js';
    import * as utils from '/src/utils/utils.js';

    const BBOX = { xl: 0, xr: 600, yt: 0, yb: 600 };
    let currentTrackIndex = 0;
    let tracks = [];
    let trackGenerator, trackEdges, diagram, splineTrack;

    document.addEventListener('DOMContentLoaded', async () => {
      tracks = await loadTrackData();
      displayTrack(currentTrackIndex);

      document.getElementById('prev-track').addEventListener('click', () => navigateTrack(-1));
      document.getElementById('next-track').addEventListener('click', () => navigateTrack(1));
    });

    document.getElementById('trackForm').addEventListener('submit', function(event) {
      event.preventDefault();
      const seed = parseFloat(document.getElementById('seedInput').value);
      const trackSize = parseInt(document.getElementById('cellCountInput').value);
      const mode = document.getElementById('modeSelect').value;
      generateTrack(seed, trackSize, mode);
    });

    async function loadTrackData() {
      try {
        const response = await fetch('/testing/tests/index.html');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const text = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(text, 'text/html');
        const links = doc.querySelectorAll('a[data-json-file]');
        const dataPromises = Array.from(links).map(link => fetch(link.getAttribute('data-json-file')).then(resp => resp.json()));
        const data = await Promise.all(dataPromises);
        return data;
      } catch (error) {
        console.error('Error loading track data:', error);
        return [];
      }
    }

    function displayTrack(index) {
      const track = tracks[index];
      if (!track) return;

      const trackContainer = document.getElementById('track-container');
      const statsContainer = document.getElementById('stats-container');

      trackContainer.innerHTML = '';
      statsContainer.innerHTML = '';

      generateTrack(track.seed, track.trackSize, track.MODE);

      const stats = `
        <p>Seed: ${track.seed}</p>
        <p>Mode: ${track.MODE}</p>
        <p>Track Size: ${track.trackSize}</p>
        <p>Length: ${track.length}</p>
        <p>Delta X: ${track.deltaX}</p>
        <p>Delta Y: ${track.deltaY}</p>
        <p>Delta Angle (Degrees): ${track.deltaAngleDegrees}</p>
      `;
      statsContainer.innerHTML = stats;
    }

    function generateTrack(seed, trackSize, mode) {
      if (isNaN(seed)) seed = Math.random();
      trackGenerator = TrackGeneratorFactory.createTrackGenerator(mode, BBOX, seed, trackSize);
      trackEdges = trackGenerator.trackEdges;
      splineTrack = utils.splineSmoothing(trackEdges);
      redraw();
    }

    window.setup = function setup() {
      createCanvas(BBOX.xr, BBOX.yb);
      noLoop();
    }

    window.draw = function draw() {
      background(0);
      if (splineTrack) {
        strokeWeight(0.5);
        noFill();
        stroke(0, 255, 0);
        strokeWeight(3);
        drawSpline(splineTrack);
      }
    }

    function drawSpline(spline) {
      beginShape();
      let startColor = color(0, 255, 255);
      let endColor = color(255, 0, 255);
      for (let i = 0; i < spline.length; i++) {
        stroke(lerpColor(startColor, endColor, i / spline.length));
        point(spline[i].x, spline[i].y);
      }
      endShape(CLOSE);
    }

    function navigateTrack(direction) {
      currentTrackIndex += direction;
      if (currentTrackIndex < 0) {
        currentTrackIndex = tracks.length - 1;
      } else if (currentTrackIndex >= tracks.length) {
        currentTrackIndex = 0;
      }
      displayTrack(currentTrackIndex);
    }

    window.setup = setup;
    window.draw = draw;
  </script>
</body>
</html>