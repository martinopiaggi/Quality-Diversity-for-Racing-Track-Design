<!DOCTYPE html>
<html lang="en">
<head>
  <title>Track Gallery Visualization</title>
  <script src="/src/lib/p5.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="gallery-container">
    <form id="trackForm">
      <label for="seedInput">Enter Seed:</label>
      <input type="text" id="seedInput" name="seedInput">
      <label for="cellCountInput">Enter Number of Cell Tracks:</label>
      <input type="text" id="cellCountInput" name="cellCountInput">
      <label for="modeSelect">Select Track Generator Mode:</label>
      <select id="modeSelect" name="modeSelect">
        <option value="voronoi">Voronoi</option>
        <option value="convexHull">Convex Hull</option>
      </select>
      <button type="submit">Generate Track</button>
    </form>

    <div class="json-input">
      <textarea id="jsonInput" rows="2" cols="50" placeholder="Paste your JSON here"></textarea>
      <button id="loadJSON">Load JSON</button>
    </div>

    <div id="track-container" class="track-container"></div>
    <div class="navigation">
      <button id="prev-track">Previous</button>
      <button id="next-track">Next</button>
    </div>
    <div id="stats-container" class="stats"></div>
  </div>

  <script type="module">
    
    import { generateTrack } from '../src/trackGen/trackGenerator.js';
    const BBOX = { xl: 0, xr: 600, yt: 0, yb: 600 };
    let currentTrackIndex = 0;
    let tracks = [];
    let splineTrack; 

    document.addEventListener('DOMContentLoaded', async () => {
      tracks = await loadTrackData();
      displayTrack(currentTrackIndex);

      document.getElementById('prev-track').addEventListener('click', () => navigateTrack(-1));
      document.getElementById('next-track').addEventListener('click', () => navigateTrack(1));
      document.getElementById('loadJSON').addEventListener('click', loadJSONTrack);
    });

    document.getElementById('trackForm').addEventListener('submit', function(event) {
      event.preventDefault();
      const seed = parseFloat(document.getElementById('seedInput').value);
      const trackSize = parseInt(document.getElementById('cellCountInput').value);
      const mode = document.getElementById('modeSelect').value;
      genTrack(seed, trackSize, mode);
    });

    async function loadTrackData() {
      try {
          const response = await fetch('/data/tests/index.json');
          if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
          }
          const fileNames = await response.json();
          const dataPromises = fileNames.map(fileName =>
              fetch(`/data/tests/${fileName}`).then(resp => resp.json())
          );
          const data = await Promise.all(dataPromises);
          return data;
        } catch (error) {
          console.error('Error loading track data:', error);
          return [];
        }
    }


    function displayTrack(index) {
      const track = tracks[index];
      if (!track) return;
      genTrack(track.id, track.trackSize, track.mode, track.dataSet, track.selectedCells);
      showStats(track)
    }

    function showStats(track){
      const trackContainer = document.getElementById('track-container');
      const statsContainer = document.getElementById('stats-container');

      trackContainer.innerHTML = '';
      statsContainer.innerHTML = '';

      const stats = `
        <p>Seed: ${track.id || 'N/A'}</p>
        <p>Mode: ${track.mode || 'N/A'}</p>
        <p>Track Size: ${track.trackSize || 'N/A'}</p>
        ${track.fitness ? `
          <p>Length: ${track.fitness.length?.toFixed(2) || 'N/A'}</p>
          <p>Delta X: ${track.fitness.deltaX?.toFixed(2) || 'N/A'}</p>
          <p>Delta Y: ${track.fitness.deltaY?.toFixed(2) || 'N/A'}</p>
          <p>Delta Angle (Degrees): ${track.fitness.deltaAngleDegrees?.toFixed(2) || 'N/A'}</p>
        ` : '<p>Fitness data not available</p>'}
      `;
      statsContainer.innerHTML = stats;
    }

    function loadJSONTrack() {
      const jsonInput = document.getElementById('jsonInput').value;
      try {
        const trackData = JSON.parse(jsonInput);
        genTrack(trackData.id, trackData.trackSize, trackData.mode, trackData.dataSet, trackData.selectedCells);
        showStats(trackData)
      } catch (error) {
        console.error('Error parsing JSON:', error);
        alert('Invalid JSON format. Please check your input.');
      }
    }

    function genTrack(seed, trackSize, mode, dataSet = [], selectedCells = []) {
      splineTrack = generateTrack(mode, BBOX, seed, trackSize, false, dataSet, selectedCells);
      redraw();
    }

    window.setup = function setup() {
      createCanvas(BBOX.xr, BBOX.yb);
      noLoop();
    }

    window.draw = function draw() {
      background(0);
      if (splineTrack) {
        strokeWeight(0.5);
        noFill();
        stroke(0, 255, 0);
        strokeWeight(3);
        drawSpline(splineTrack);
      }
    }

    async function drawSpline(spline) {
      const resolvedSpline = await spline;
      beginShape();
      let startColor = color(0, 255, 255);
      let endColor = color(255, 0, 255);
      for (let i = 0; i < resolvedSpline.length; i++) {
        stroke(lerpColor(startColor, endColor, i / resolvedSpline.length));
        point(resolvedSpline[i].x, resolvedSpline[i].y);
      }
      endShape(CLOSE);
    }

    function navigateTrack(direction) {
      currentTrackIndex += direction;
      if (currentTrackIndex < 0) {
        currentTrackIndex = tracks.length - 1;
      } else if (currentTrackIndex >= tracks.length) {
        currentTrackIndex = 0;
      }
      displayTrack(currentTrackIndex);
    }

    window.setup = setup;
    window.draw = draw;
  </script>
</body>
</html>